<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>QR Attendance Scanner</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #f1f1f1;
      height: 100vh;
      justify-content: center;
    }
    #reader {
      width: 100%;
      max-width: 480px;
      margin: auto;
    }
    #status {
      margin-top: 1rem;
      font-size: 1rem;
      color: #333;
    }
  </style>
  <!-- 1) Include the â€œHTML5 QR codeâ€ library from unpkg CDN -->
  <script src="https://unpkg.com/html5-qrcode@2.3.6/minified/html5-qrcode.min.js"></script>
</head>
<body>

  <div id="reader"></div>
  <div id="status">ğŸ¥ Point camera at studentâ€™s QR</div>

  <script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //  Replace this with your own Apps Script â€œdoGetâ€ URL:
    const LOG_URL = "https://script.google.com/macros/s/AKfycbxTLAyIuhbdQPaD_V9IDIo4c_ElVIyU3kEnpAy6_9D55jxQml2A822TjViBB8c2Oe8F/exec";
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // This flag prevents multiple sends for the same frame:
    let lastScannedText = "";

    // 1) Create the QR-decoder:
    const html5QrCode = new Html5Qrcode("reader");

    function onScanSuccess(decodedText, decodedResult) {
      // If itâ€™s the same text as last time, ignore:
      if (decodedText === lastScannedText) return;

      lastScannedText = decodedText;
      document.getElementById("status").innerText = `Scanned: ${decodedText} â†’ loggingâ€¦`;

      // 2) Send to Apps Script endpoint:
      fetch(LOG_URL + "?id=" + encodeURIComponent(decodedText))
        .then(res => res.text())
        .then(txt => {
          if (txt.trim() === "OK") {
            document.getElementById("status").innerText = `âœ… Logged â€œ${decodedText}â€ at ${new Date().toLocaleTimeString()}`;
          } else {
            document.getElementById("status").innerText = `âš ï¸ Server returned: ${txt}`;
          }
          // Clear â€œlastScannedTextâ€ after 2 seconds so you can scan that same ID again if needed
          setTimeout(() => {
            lastScannedText = "";
            document.getElementById("status").innerText = "ğŸ¥ Point camera at next QR";
          }, 2000);
        })
        .catch(err => {
          console.error(err);
          document.getElementById("status").innerText = "âŒ Error logging. Check console.";
          setTimeout(() => {
            lastScannedText = "";
            document.getElementById("status").innerText = "ğŸ¥ Point camera at next QR";
          }, 2000);
        });
    }

    function onScanFailure(error) {
      // you can ignore or log these
      // console.warn(`QR decode failed: ${error}`);
    }

    // 3) Start the camera & scanning loop:
    Html5Qrcode.getCameras().then(cameras => {
      if (cameras && cameras.length) {
        // Prefer back camera if available:
        const cameraId = cameras[0].id;
        html5QrCode.start(
          cameraId,
          { fps: 10, qrbox: { width: 250, height: 250 } },
          onScanSuccess,
          onScanFailure
        ).catch(err => {
          document.getElementById("status").innerText = "âŒ Camera start failed: " + err;
        });
      } else {
        document.getElementById("status").innerText = "âš ï¸ No camera found.";
      }
    }).catch(err => {
      document.getElementById("status").innerText = "âŒ Error getting cameras: " + err;
    });
  </script>
</body>
</html>
