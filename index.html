<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>QR Attendance (Full‚ÄêScreen + On‚ÄêScreen Debug)</title>

  <style>
    /* Make html/body fill the viewport */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    body {
      background: #000;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      color: #fff;
      font-family: sans-serif;
    }

    /* FULL‚ÄêSCREEN video container */
    #video-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
      overflow: hidden;
      z-index: 1;
    }
    #qr-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* A translucent status/message overlay on top of video */
    #overlay {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100vw;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      text-align: center;
      z-index: 2;
    }
    #start-btn {
      margin-top: 0.5rem;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      background: #2196F3;
      border: none;
      color: white;
      border-radius: 4px;
    }
    #start-btn:disabled {
      background: #555;
    }

    /* A scrollable debug area so you can see logs */
    #debug {
      position: fixed;
      top: 0;
      right: 0;
      width: 35vw;
      max-width: 200px;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      color: #0f0;
      font-size: 0.75rem;
      overflow-y: auto;
      padding: 0.5rem;
      box-sizing: border-box;
      z-index: 3;
    }
  </style>

  <!-- Load QR-Scanner from CDN -->
  <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
</head>

<body>
  <!-- 1) Full‚Äêscreen camera preview -->
  <div id="video-container">
    <video id="qr-video"></video>
  </div>

  <!-- 2) Overlay for status + ‚ÄúStart Camera‚Äù button -->
  <div id="overlay">
    <div id="status">‚ö†Ô∏è Camera not started yet.</div>
    <button id="start-btn">‚ñ∂Ô∏è Start Camera</button>
  </div>

  <!-- 3) On‚Äêscreen debug panel (scrollable) -->
  <div id="debug">
    <div><strong>DEBUG LOG:</strong></div>
  </div>

  <script>
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // 1) Your Google Apps Script ‚ÄúdoGet‚Äù URL (replace with your own):
    const LOG_URL = "https://script.google.com/macros/s/AKfycbxTLAyIuhbdQPaD_V9IDIo4c_ElVIyU3kEnpAy6_9D55jxQml2A822TjViBB8c2Oe8F/exec";
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    const statusDiv = document.getElementById("status");
    const startBtn   = document.getElementById("start-btn");
    const debugDiv   = document.getElementById("debug");
    let qrScanner    = null;
    let lastScannedText = "";

    // Utility: write errors/messages into #debug box:
    function debugLog(msg) {
      const entry = document.createElement("div");
      entry.innerText = msg;
      debugDiv.appendChild(entry);
      // Keep scroll at bottom
      debugDiv.scrollTop = debugDiv.scrollHeight;
    }

    // Called whenever a QR is successfully decoded:
    function onDecodeSuccess(result) {
      if (result === lastScannedText) return;
      lastScannedText = result;
      statusDiv.innerText = `üì• Scanned ‚Äú${result}‚Äù ‚Üí logging‚Ä¶`;
      debugLog("Decoded QR: " + result);

      // Test: ping the URL first (GET without ?id=) so we know if endpoint is reachable
      debugLog("Pinging LOG_URL without parameters‚Ä¶");
      fetch(LOG_URL)
        .then(r => {
          debugLog("Ping status: " + r.status + " " + r.statusText);
          // Now actually log with ?id=
          debugLog("Sending fetch to " + LOG_URL + "?id=" + encodeURIComponent(result));
          return fetch(LOG_URL + "?id=" + encodeURIComponent(result));
        })
        .then(r => {
          debugLog("Log‚Äêfetch status: " + r.status + " " + r.statusText);
          return r.text();
        })
        .then(txt => {
          debugLog("Server returned text: " + txt);
          if (txt.trim() === "OK") {
            const now = new Date().toLocaleTimeString();
            statusDiv.innerText = `‚úÖ Logged ‚Äú${result}‚Äù at ${now}`;
            debugLog("‚Üí Logged OK at ‚Äú" + now + "‚Äù");
          } else {
            statusDiv.innerText = `‚ö†Ô∏è Server said: ${txt}`;
            debugLog("‚Üí Unexpected server response: ‚Äú" + txt + "‚Äù");
          }
          // Reset after 2s so the same QR can be scanned again:
          setTimeout(() => {
            lastScannedText = "";
            statusDiv.innerText = "üé• Ready for next QR";
          }, 2000);
        })
        .catch(err => {
          debugLog("‚ùå Fetch network error: " + err);
          statusDiv.innerText = "‚ùå Error logging. Check debug.";
          setTimeout(() => {
            lastScannedText = "";
            statusDiv.innerText = "üé• Ready for next QR";
          }, 2000);
        });
    }

    function onDecodeError(error) {
      // Normally many ‚Äúno QR in this frame‚Äù errors happen. You can uncomment to log them:
      // debugLog("Decode error: " + error);
    }

    // ‚îÄ‚îÄ‚îÄ Start camera on button click ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    startBtn.addEventListener("click", () => {
      startBtn.disabled = true;
      statusDiv.innerText = "üîÑ Loading cameras‚Ä¶";
      debugLog("User tapped Start Camera ‚Üí initiating QrScanner.");

      // Create a new QrScanner instance
      qrScanner = new QrScanner(
        document.getElementById("qr-video"),
        onDecodeSuccess,
        onDecodeError,
        {
          highlightScanRegion: true,
          highlightCodeOutline: true,
        }
      );

      // Enumerate cameras, pick ‚Äúback‚Äù if available
      QrScanner.listCameras(true)
        .then(cameras => {
          debugLog("listCameras returned: " + JSON.stringify(cameras.map(c => c.label)));
          if (!cameras || cameras.length === 0) {
            statusDiv.innerText = "‚ö†Ô∏è No cameras found.";
            debugLog("‚ö†Ô∏è No cameras array or length 0");
            startBtn.disabled = false;
            return;
          }

          // Default to first, but prefer one whose label includes ‚Äúback‚Äù or ‚Äúenv‚Äù
          let backCameraId = cameras[0].id;
          for (let cam of cameras) {
            const label = cam.label.toLowerCase();
            if (label.includes("back") || label.includes("env")) {
              backCameraId = cam.id;
              break;
            }
          }
          debugLog("Chosen camera ID: " + backCameraId);

          // Start scanning on that camera
          qrScanner.start(backCameraId)
            .then(() => {
              statusDiv.innerText = "‚úÖ Camera started. Point at QR.";
              debugLog("üé• QrScanner.start() succeeded.");
            })
            .catch(err => {
              console.error("Could not start camera:", err);
              debugLog("‚ùå QrScanner.start() failed: " + err);
              statusDiv.innerText = "‚ùå Camera start failed: " + err;
              startBtn.disabled = false;
            });
        })
        .catch(err => {
          console.error("Error listing cameras:", err);
          debugLog("‚ùå listCameras() error: " + err);
          statusDiv.innerText = "‚ùå Could not list cameras: " + err;
          startBtn.disabled = false;
        });
    });
  </script>
</body>
</html>
