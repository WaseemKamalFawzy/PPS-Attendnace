<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>QR Attendance Scanner</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background: #f1f1f1;
      display: flex;
      flex-direction: column;
      height: 100vh;
      align-items: center;
      justify-content: center;
    }

    /* Make sure the scanner box is visible */
    #reader {
      width: 100%;
      max-width: 480px;
      height: 60vh;           
      background: black;      
      position: relative;
    }

    #status {
      margin-top: 1rem;
      font-size: 1rem;
      color: #333;
      text-align: center;
      max-width: 480px;
      padding: 0 1rem;
    }
  </style>

  <!-- 1) Load the HTML5-QRCode library FROM A RELIABLE CDN -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
</head>

<body>
  <div id="reader"></div>
  <div id="status">üé• Point camera at student‚Äôs QR</div>

  <!-- ‚îÄ‚îÄ‚îÄ 2) OUR SCRIPT: placed AFTER the library tag ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <script>
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //  Replace this with YOUR ‚ÄúdoGet‚Äù URL from Google Apps Script
    const LOG_URL = "https://script.google.com/macros/s/AKfycbx‚Ä¶/exec";
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    let lastScannedText = "";

    function onScanSuccess(decodedText, decodedResult) {
      if (decodedText === lastScannedText) return;
      lastScannedText = decodedText;
      document.getElementById("status").innerText =
        `Scanned: ‚Äú${decodedText}‚Äù ‚Üí logging‚Ä¶`;

      fetch(LOG_URL + "?id=" + encodeURIComponent(decodedText))
        .then(res => res.text())
        .then(txt => {
          if (txt.trim() === "OK") {
            const now = new Date().toLocaleTimeString();
            document.getElementById("status").innerText =
              `‚úÖ Logged ‚Äú${decodedText}‚Äù at ${now}`;
          } else {
            document.getElementById("status").innerText =
              `‚ö†Ô∏è Server returned: ${txt}`;
          }
          setTimeout(() => {
            lastScannedText = "";
            document.getElementById("status").innerText =
              "üé• Point camera at next QR";
          }, 2000);
        })
        .catch(err => {
          console.error("Fetch error:", err);
          document.getElementById("status").innerText =
            "‚ùå Network error. Check console.";
          setTimeout(() => {
            lastScannedText = "";
            document.getElementById("status").innerText =
              "üé• Point camera at next QR";
          }, 2000);
        });
    }

    function onScanFailure(error) {
      // You can log errors here if you want:
      // console.warn(`QR decode failed: ${error}`);
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //  Start the camera & scanning. Notice we use Html5Qrcode *after* it‚Äôs loaded.
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const html5QrCode = new Html5Qrcode("reader");

    Html5Qrcode.getCameras()
      .then(cameras => {
        if (cameras && cameras.length) {
          // Prefer back camera if possible:
          let cameraId = cameras[0].id;
          for (let cam of cameras) {
            if (
              cam.label.toLowerCase().includes("back") ||
              cam.label.toLowerCase().includes("env")
            ) {
              cameraId = cam.id;
              break;
            }
          }
          html5QrCode
            .start(
              cameraId,
              {
                fps: 10,
                qrbox: { width: 250, height: 250 }
              },
              onScanSuccess,
              onScanFailure
            )
            .then(() => {
              document.getElementById("status").innerText =
                "‚úÖ Camera started. Point at QR.";
            })
            .catch(err => {
              console.error("Camera start failed:", err);
              document.getElementById("status").innerText =
                "‚ùå Camera failed to start: " + err;
            });
        } else {
          document.getElementById("status").innerText =
            "‚ö†Ô∏è No cameras found on this device.";
        }
      })
      .catch(err => {
        console.error("getCameras() error:", err);
        document.getElementById("status").innerText =
          "‚ùå Unable to query cameras: " + err;
      });
  </script>
</body>
</html>
